# Semaphore

В этой задаче вам предстоит усовершенствовать один из базовых примитивов
синхронизации --- семафор. В отличие от мьютекса, семафор позволяет не одному, а сразу $`n`$
потокам входить в критическую секцию.

Семафор можно представить как объект, содержащий счетчик (начальное значение которого равно $`n`$) и поддерживающий следующие операции:
* _enter_ --- если значение счетчика равно 0, то вызывающий поток блокируется до тех пор, пока оно не станет положительным.
Далее счетчик уменьшается.
* _leave_ --- увеличение счетчика на 1.

Таким образом, _enter_ обозначает вход очередного потока в критическую секцию, а _leave_ --- выход из нее.
Из этого же определения следует, что мьютекс можно представить как бинарный семафор, значение которого изначально равно 1.

Более подробно ознакомиться можно [здесь](https://en.wikipedia.org/wiki/Semaphore_(programming)).

В файле `sema.h` представлена реализация семафора с использованием условной переменной. Обратите внимание на то, что `enter` принимает шаблонный аргумент.
Туда передается функция, которая принимает счетчик и уменьшает его на 1, возможно совершая еще какие-то действия.
Таким образом, вызов enter и callback является атомарным, а в callback может войти только один поток.
Это нужно исключительно для тестирования, при использовании семафора в подобной функции нужды нет.

У данной реализации есть недостаток --- поскольку стандарт C++ не гарантирует, что порядок пробуждения от `notify` совпадает с порядком вызовов
`wait` (и на практике такой порядок действительно не наблюдается), то какие-то потоки потенциально могут голодать или же вообще ждать выхода из `enter` бесконечно долго.

Чтобы этого избежать, семафор должен гарантировать, что порядок вызова `enter` совпадает с порядком выхода из него (а в терминах тестирования с порядком вызовов передаваемого `callback`).
Ваша задача состоит в том, чтобы реализовать такой семафор.

### Вопросы

* Подумайте, можно ли как-то протестировать указанные требования к семафору без использования `callback`?
* Какую реализацию вы бы предпочли использовать на практике, с сохранением порядка или без?
* Семафор --- один из старейших и базовых примитивов синхронизации. Подумайте, почему, в отличие от мьютекса, его нет в стандартной библиотеке?

### Полезные ссылки
* http://en.cppreference.com/w/cpp/thread/condition_variable
* http://en.cppreference.com/w/cpp/thread/unique_lock
* https://en.wikipedia.org/wiki/Spurious_wakeup
