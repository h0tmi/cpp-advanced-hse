# Coroutine

В этой задаче вам предстоит ~~собрать буст~~ реализовать сопрограмму.

Чтобы понять, что это такое, рассмотрим пример:

```cpp
void coroFn() {
    std::cout << 1;
    suspend();
    std::cout << 2;
}

std::cout << 3;
Coroutine c(coroFn);
std::cout << 4;
c.resume();
std::cout << 5;
```

На экране должны быть выведено `31425`.

Т.е. в каждый момент сопрограмма может остановить свое выполнение вызовом `suspend()` и переключиться на вызывающую функцию. Чтобы продолжить исполнения с точки последнего вызова `suspend()` необходимо на экземпляре объекта `Coroutine` позвать метод `resume()`.

Стоит обратить внимание, что функция `suspend()` не является методом класса `Coroutine`. Возникает вопрос: "а как узнать экземпляр текущей сопрограммы?" Для этого можно воспользовать thread local storage переменной:

```cpp
thread_local Coroutine* currentCoroutine = nullptr;
```

Перед входом в сопрограмму необходимо поменять значение этой переменной, а после выхода - сбросить.

## Context

Для решения этой задачи нужно использовать boost версии не ниже 1.64. На сервере установлена версия 1.71.

Используйте инклюд

```
#include <boost/context/continuation.hpp>
```

На Ubuntu и подобных сначала попробуйте установить libboost-context-dev, если не сработает, то libboost-dev и если снова нет, то читайте дальше. Если у вас Mac, попробуйте `brew install boost`, но оно принесёт очень много всего.

Обратите внимание, что если вы используете ubuntu старой версии, то вполне вероятно, что пакет по умолчанию у вас ниже версией, поэтому
воспользуйтесь следующей инструкцией для локальной сборки нужной версии буста:
[ссылка](https://www.boost.org/doc/libs/1_71_0/more/getting_started/unix-variants.html).

Вам нужна только библиотека `context`, используйте флаг `--with-libraries=context` при установке, как указано в инструкции.
Если вы не хотите, чтобы возникали коллизии с уже установленной версией boost, вы можете установить его в локальную директорию
с помощью флага `--prefix`. После этого используйте `-DBOOST_ROOT=<path>` при запуске cmake, чтобы указать куда вы установили boost.

Обратите внимание, что старые версии cmake некорректно работают с новыми версиями boost (в частности, нужен cmake не ниже 3.8 для
1.64 и 3.11 для 1.66), поэтому вам также может понадобиться собрать cmake вручную. Инструкцию можно найти
[здесь](https://askubuntu.com/questions/355565/how-do-i-install-the-latest-version-of-cmake-from-the-command-line/355574)
(следующий ответ после одобренного).

Для реализации понадобится манипуляция с контекстом исполнения, т.е. мы будем переключать контекст с одного на другой. Используйте [`boost::context::callcc`](https://www.boost.org/doc/libs/1_71_0/libs/context/doc/html/context/cc.html).

### Полезные ссылки

- [Thread local storage](https://en.wikipedia.org/wiki/Thread-local_storage)

### Ограничения

1. Запрещено использовать `boost.coroutine`.
1. Запрещено использовать `boost.fiber`.
1. Запрещено использовать `std.coroutine`.
